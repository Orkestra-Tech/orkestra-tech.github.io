<html><head><title>Orkestra: Github</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="com.goyeau" /><meta name="description" content="DevOps with Scala and Kubernetes" /><meta name="og:image" content="/orkestra/img/poster.png" /><meta name="og:title" content="Orkestra: Github" /><meta name="og:site_name" content="Orkestra" /><meta name="og:url" content="https://orkestracd.github.io/orkestra/" /><meta name="og:type" content="website" /><meta name="og:description" content="DevOps with Scala and Kubernetes" /><link rel="icon" type="image/png" href="/orkestra/img/favicon.png" /><meta name="twitter:title" content="Orkestra: Github" /><meta name="twitter:image" content="https://orkestracd.github.io/orkestra/img/poster.png" /><meta name="twitter:description" content="DevOps with Scala and Kubernetes" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/orkestra/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/orkestra/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/orkestra/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/orkestra/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/orkestra/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/orkestra/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/orkestra/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/orkestra/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/orkestra/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/orkestra/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/orkestra/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/orkestra/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/orkestra/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/orkestra/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/orkestra/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/orkestra/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/orkestra/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/orkestra/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/orkestra/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/orkestra/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/orkestra/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/orkestra/css/style.css" /><link rel="stylesheet" href="/orkestra/css/palette.css" /><link rel="stylesheet" href="/orkestra/css/codemirror.css" /><link rel="stylesheet" href="/orkestra/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/orkestra/" class="brand"><div class="brand-wrapper"><span>Orkestra</span></div></a></li> <li><a href="/orkestra/jobsboards.html" class="">Jobs & Boards</a></li> <li><a href="/orkestra/config.html" class="">Config</a></li> <li><a href="/orkestra/parameters.html" class="">Parameters</a></li> <li><a href="/orkestra/stages.html" class="">Stages</a></li> <li><a href="/orkestra/shells.html" class="">Shell scripts</a></li> <li><a href="/orkestra/directories.html" class="">Directories</a></li> <li><a href="/orkestra/secrets.html" class="">Secrets</a></li> <li><a href="/orkestra/triggers.html" class="">Triggering jobs</a></li> <li><a href="/orkestra/runid.html" class="">RunId</a></li> <li><a href="/orkestra/containers.html" class="">Containers</a></li> <li><a href="/orkestra/plugins" class="">Plugins</a> <ul class="sub_section"> <li><a href="/orkestra/plugins/github.html" class=" active ">Github</a></li> <li><a href="/orkestra/plugins/cron.html" class="">Cron jobs</a></li> <li><a href="/orkestra/plugins/locking.html" class="">Locking</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/OrkestraCD/orkestra"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/OrkestraCD/orkestra"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Orkestra DevOps with Scala and Kubernetes');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Orkestra DevOps with Scala and Kubernetes');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="OrkestraCD" data-github-repo="orkestra"><div class="content-wrapper"><section><h1 id="github-integration">Github Integration</h1>

<p>Orkestra has a Github integration via the <code class="highlighter-rouge">orkestra-github</code> library/plugin. We can do so by adding the dependency in
<code class="highlighter-rouge">build.sbt</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"com.goyeau"</span> <span class="o">%%%</span> <span class="s">"orkestra-github"</span> <span class="o">%</span> <span class="n">orkestraVersion</span>
</code></pre></div></div>

<p>To add a webhook server so that Github can trigger jobs, we mix in the trait <code class="highlighter-rouge">GithubHooks</code>, which requires us to
implement <code class="highlighter-rouge">githubTriggers: Set[GithubTrigger]</code>. There is two implementation of <code class="highlighter-rouge">GithubTrigger</code>:</p>
<ul>
  <li><code class="highlighter-rouge">BranchTrigger</code> which let’s you trigger a job when a change is done on a branch.</li>
  <li><code class="highlighter-rouge">PullRequestTrigger</code> to listen on pull request changes.</li>
</ul>

<p>Let’s have a look first to <code class="highlighter-rouge">BranchTrigger</code>:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.goyeau.orkestra._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.Dsl._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.board._</span>
<span class="c1">// We import the Github package
</span><span class="k">import</span> <span class="nn">com.goyeau.orkestra.github._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.job._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.model._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.parameter._</span>

<span class="k">object</span> <span class="nc">Orkestra</span> <span class="k">extends</span> <span class="nc">OrkestraServer</span> <span class="k">with</span> <span class="nc">GithubHooks</span> <span class="o">{</span> <span class="c1">// Note that we mix in GithubHooks
</span>  <span class="k">lazy</span> <span class="k">val</span> <span class="n">board</span> <span class="k">=</span> <span class="nc">Folder</span><span class="o">(</span><span class="s">"Orkestra"</span><span class="o">)(</span><span class="n">branchJobBoard</span><span class="o">)</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">jobs</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="n">branchJob</span><span class="o">)</span> <span class="c1">// We still need to add the Job to jobs
</span>  
  <span class="c1">// We add the BranchTrigger to the githubTriggers
</span>  <span class="k">lazy</span> <span class="k">val</span> <span class="n">githubTriggers</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">BranchTrigger</span><span class="o">(</span><span class="nc">Repository</span><span class="o">(</span><span class="s">"myOrganisation/myRepo"</span><span class="o">),</span> <span class="s">"master"</span><span class="o">,</span> <span class="n">branchJob</span><span class="o">)())</span>

  <span class="k">lazy</span> <span class="k">val</span> <span class="n">branchJobBoard</span> <span class="k">=</span> <span class="nc">JobBoard</span><span class="o">[</span><span class="kt">GitRef</span> <span class="k">=&gt;</span> <span class="kt">Unit</span><span class="o">](</span><span class="nc">JobId</span><span class="o">(</span><span class="s">"branch"</span><span class="o">),</span> <span class="s">"Branch"</span><span class="o">)(</span><span class="nc">Input</span><span class="o">[</span><span class="kt">GitRef</span><span class="o">](</span><span class="s">"Git ref"</span><span class="o">))</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">branchJob</span> <span class="k">=</span> <span class="nc">Job</span><span class="o">(</span><span class="n">branchJobBoard</span><span class="o">)</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">workDir</span> <span class="k">=&gt;</span> <span class="n">gitRef</span> <span class="k">=&gt;</span>
    <span class="n">println</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Before we jump into the <code class="highlighter-rouge">PullRequestTrigger</code> I’d like to introduce <code class="highlighter-rouge">Github.statusUpdated</code>, a little utility function
that checkouts the Git ref and run the code updating the status on Github for the Git ref
(<img alt="Github pending" srcset="../img/github-pending.png 2x" /><img alt="Github success" srcset="../img/github-success.png 2x" /><img alt="Github failure" srcset="../img/github-failure.png 2x" />)
according to if an exception has been thrown in the code:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.goyeau.orkestra._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.Dsl._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.board._</span>
<span class="c1">// We import the Github package
</span><span class="k">import</span> <span class="nn">com.goyeau.orkestra.github._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.job._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.model._</span>
<span class="k">import</span> <span class="nn">com.goyeau.orkestra.parameter._</span>

<span class="k">object</span> <span class="nc">Orkestra</span> <span class="k">extends</span> <span class="nc">OrkestraServer</span> <span class="k">with</span> <span class="nc">GithubHooks</span> <span class="o">{</span> <span class="c1">// Note that we mix in GithubHooks
</span>  <span class="k">lazy</span> <span class="k">val</span> <span class="n">board</span> <span class="k">=</span> <span class="nc">Folder</span><span class="o">(</span><span class="s">"Orkestra"</span><span class="o">)(</span><span class="n">pullRequestJobBoard</span><span class="o">)</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">jobs</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="n">pullRequestJob</span><span class="o">)</span> <span class="c1">// We still need to add the Job to jobs
</span>
  <span class="c1">// We add the PullRequestTrigger to the githubTriggers 
</span>  <span class="k">lazy</span> <span class="k">val</span> <span class="n">githubTriggers</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">PullRequestTrigger</span><span class="o">(</span><span class="nc">Repository</span><span class="o">(</span><span class="s">"myOrganisation/myRepo"</span><span class="o">),</span> <span class="n">pullRequestJob</span><span class="o">)())</span>

  <span class="k">lazy</span> <span class="k">val</span> <span class="n">pullRequestJobBoard</span> <span class="k">=</span> <span class="nc">JobBoard</span><span class="o">[</span><span class="kt">GitRef</span> <span class="k">=&gt;</span> <span class="kt">Unit</span><span class="o">](</span><span class="nc">JobId</span><span class="o">(</span><span class="s">"pullRequest"</span><span class="o">),</span> <span class="s">"Pull Request"</span><span class="o">)(</span>
    <span class="nc">Input</span><span class="o">[</span><span class="kt">GitRef</span><span class="o">](</span><span class="s">"Git ref"</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="k">lazy</span> <span class="k">val</span> <span class="n">pullRequestJob</span> <span class="k">=</span> <span class="nc">Job</span><span class="o">(</span><span class="n">pullRequestJobBoard</span><span class="o">)</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">workDir</span> <span class="k">=&gt;</span> <span class="n">gitRef</span> <span class="k">=&gt;</span>
    <span class="nc">Github</span><span class="o">.</span><span class="n">statusUpdated</span><span class="o">(</span><span class="nc">Repository</span><span class="o">(</span><span class="s">"myOrganisation/myRepo"</span><span class="o">),</span> <span class="n">gitRef</span><span class="o">)</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">workDir</span> <span class="k">=&gt;</span>
      <span class="n">println</span><span class="o">(</span><span class="s">"This PR is good of course"</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="config">Config</h2>

<ul>
  <li><code class="highlighter-rouge">ORKESTRA_GITHUB_URI</code>: The URI of the home page as Github displays links to it for PRs for example. Required.</li>
  <li><code class="highlighter-rouge">ORKESTRA_GITHUB_TOKEN</code>: The token of the account that will be used to clone or to update commit statuses. Required.</li>
  <li><code class="highlighter-rouge">ORKESTRA_GITHUB_BIND_PORT</code>: The separate port where to bind the Github Hooks server. Default <code class="highlighter-rouge">8081</code>.</li>
</ul>

<p>The reason why the Github hooks server is bound on separate port is so that you can make Orkestra accessible only
internally but still expose the Github hooks server on the public network.</p>

<p>Once we have the hooks setup in Orkestra we need Github to call them. We can do so in the settings of the repository
(<code class="highlighter-rouge">https://github.com/&lt;org&gt;/&lt;repo&gt;/settings/hooks</code>) where we will <code class="highlighter-rouge">Add webhook</code> as the following:</p>
<ul>
  <li><code class="highlighter-rouge">Payload URL</code>: <code class="highlighter-rouge">http://&lt;host&gt;/webhooks</code></li>
  <li><code class="highlighter-rouge">Content type</code>: <code class="highlighter-rouge">application/json</code></li>
  <li><code class="highlighter-rouge">Send me everything.</code></li>
</ul>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/orkestra/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'OrkestraCD/Orkestra'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/orkestra/js/main.js"></script></body></html>